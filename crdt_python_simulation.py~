import tkinter as tk
from tkinter import filedialog, messagebox, colorchooser
import ctypes, os
from PIL import Image, ImageTk

# Chargement de la lib C
lib = ctypes.CDLL(os.path.abspath("editor.so"))
lib.c_get_content.restype = ctypes.c_char_p

class Range(ctypes.Structure):
    _fields_ = [("start", ctypes.c_int), ("end", ctypes.c_int)]

class DocumentImage(ctypes.Structure):
    _fields_ = [("path", ctypes.c_char * 256), ("pos", ctypes.c_int), ("w", ctypes.c_int), ("h", ctypes.c_int)]
lib.c_get_image_info.restype = DocumentImage

class WordClone:
    def __init__(self, root):
        self.root = root
        self.root.title("Word Clone - Moteur C & Interface Python")
        self.root.geometry("1200x900")
        self.img_refs = []

        # --- RUBAN WORD ---
        ribbon = tk.Frame(root, bg="#2b579a", height=80)
        ribbon.pack(fill=tk.X)
        
        toolbar = tk.Frame(root, bg="#f3f2f1", bd=1, relief="raised")
        toolbar.pack(fill=tk.X)

        # Style & Police
        self.font_fam = tk.StringVar(value="Calibri")
        tk.OptionMenu(toolbar, self.font_fam, "Calibri", "Arial", "Courier", "Times", command=self.update_style).pack(side=tk.LEFT, padx=5)

        # Mise en forme
        tk.Button(toolbar, text="G", font=("Arial", 10, "bold"), command=lambda: self.apply_tag("bold")).pack(side=tk.LEFT, padx=2)
        tk.Button(toolbar, text="I", font=("Arial", 10, "italic"), command=lambda: self.apply_tag("italic")).pack(side=tk.LEFT, padx=2)
        tk.Button(toolbar, text="S", font=("Arial", 10, "underline"), command=lambda: self.apply_tag("underline")).pack(side=tk.LEFT, padx=2)
        
        # Couleur
        tk.Button(toolbar, text="Couleur", command=self.choose_color).pack(side=tk.LEFT, padx=5)

        # Image & Recherche
        tk.Button(toolbar, text="üñº Image", command=self.add_img).pack(side=tk.LEFT, padx=5)
        self.slider = tk.Scale(toolbar, from_=50, to=600, orient=tk.HORIZONTAL, command=self.resize_last_img)
        self.slider.set(200)
        self.slider.pack(side=tk.LEFT, padx=10)

        self.search_ent = tk.Entry(toolbar)
        self.search_ent.pack(side=tk.LEFT, padx=5)
        tk.Button(toolbar, text="üîç", command=self.search).pack(side=tk.LEFT)

        # --- ZONE DE TEXTE ---
        self.txt = tk.Text(root, font=("Calibri", 12), undo=False, bg="white", padx=50, pady=50)
        self.txt.pack(expand=True, fill=tk.BOTH, padx=20, pady=10)
        
        # Tags de style
        self.txt.tag_config("bold", font=(self.font_fam.get(), 12, "bold"))
        self.txt.tag_config("italic", font=(self.font_fam.get(), 12, "italic"))
        self.txt.tag_config("underline", underline=True)
        self.txt.tag_config("err", foreground="red", underline=True)
        self.txt.tag_config("match", background="yellow")

        self.txt.bind("<Key>", self.on_key)
        self.refresh()

    def apply_tag(self, tag):
        try: self.txt.tag_add(tag, "sel.first", "sel.last")
        except: pass

    def choose_color(self):
        color = colorchooser.askcolor()[1]
        if color:
            tag = f"col_{color}"
            self.txt.tag_config(tag, foreground=color)
            self.apply_tag(tag)

    def update_style(self, _):
        f = self.font_fam.get()
        self.txt.configure(font=(f, 12))
        self.txt.tag_config("bold", font=(f, 12, "bold"))
        self.txt.tag_config("italic", font=(f, 12, "italic"))

    def on_key(self, event):
        pos = int(self.txt.index(tk.INSERT).split('.')[1])
        if event.keysym == "BackSpace": lib.c_delete_char(pos)
        elif len(event.char) == 1: lib.c_insert_char(pos, event.char.encode())
        self.refresh()
        return "break"

    def refresh(self):
        content = lib.c_get_content().decode()
        curr = self.txt.index(tk.INSERT)
        self.txt.delete("1.0", tk.END)
        self.txt.insert("1.0", content)
        
        # Rendu Images
        self.img_refs = []
        for i in range(lib.c_get_image_count()):
            info = lib.c_get_image_info(i)
            img = Image.open(info.path.decode()).resize((info.w, info.h))
            tk_img = ImageTk.PhotoImage(img)
            self.img_refs.append(tk_img)
            self.txt.image_create(f"1.{info.pos}", image=tk_img)

        # Orthographe
        errs = (Range * 50)()
        n = lib.c_get_spell_errors(errs)
        for i in range(n): self.txt.tag_add("err", f"1.{errs[i].start}", f"1.{errs[i].end}")
        
        self.txt.mark_set(tk.INSERT, curr)

    def add_img(self):
        f = filedialog.askopenfilename()
        if f: 
            pos = int(self.txt.index(tk.INSERT).split('.')[1])
            lib.c_add_image(f.encode(), pos)
            self.refresh()

    def resize_last_img(self, v):
        count = lib.c_get_image_count()
        if count > 0:
            lib.c_resize_image(count-1, int(v), int(int(v)*0.75))
            self.refresh()

    def search(self):
        res = (Range * 50)()
        n = lib.c_find_pattern(self.search_ent.get().encode(), res)
        self.txt.tag_remove("match", "1.0", tk.END)
        for i in range(n): self.txt.tag_add("match", f"1.{res[i].start}", f"1.{res[i].end}")

if __name__ == "__main__":
    r = tk.Tk()
    app = WordClone(r)
    r.mainloop()
